var selectedRange;
(function (a) {
    a.fn.contextmenu = function (b) {
        var c = {
            inDuration: 300,
            outDuration: 225,
            gutter: 0,
            alignment: "left",
            stopPropagation: false
        };
        if (b === "open") {
            this.each(function () {
                a(this).trigger("open")
            });
            return false
        }
        if (b === "close") {
            this.each(function () {
                a(this).trigger("close")
            });
            return false
        }
        this.each(function () {
            var i = a(this);
            var d = a.extend({}, c, b);
            var f = false;
            var k = a("#" + i.attr("data-activates"));
            function e() {
                if (i.data("induration") !== undefined) {
                    d.inDuration = i.data("induration")
                }
                if (i.data("outduration") !== undefined) {
                    d.outDuration = i.data("outduration")
                }
                if (i.data("gutter") !== undefined) {
                    d.gutter = i.data("gutter")
                }
                if (i.data("alignment") !== undefined) {
                    d.alignment = i.data("alignment")
                }
                if (i.data("stoppropagation") !== undefined) {
                    d.stopPropagation = i.data("stoppropagation")
                }
            }
            e();
            i.after(k);
            function l(n) {
                var m = 0;
                var o = 0;
                if (!n) {
                    var n = window.event
                }
                if (n.pageX || n.pageY) {
                    m = n.pageX;
                    o = n.pageY
                } else {
                    if (n.clientX || n.clientY) {
                        m = n.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                        o = n.clientY + document.body.scrollTop + document.documentElement.scrollTop
                    }
                }
                return {
                    x: m,
                    y: o
                }
            }
            function j(w, p) {
                if (p === "focus") {
                    f = true
                }
                e();
                k.addClass("active");
                i.addClass("active");
                k.css("white-space", "nowrap");
                var n = l(w);
                var m = window.innerHeight;
                var r = n.x;
                var q = n.y;
                var t = d.alignment;
                var y = 0;
                var u = 0;
                var z = 0;
                var v = 0;
                var x = 0;
                if (r + k.innerWidth() > a(window).width()) {
                    t = "right"
                } else {
                    if (r - k.innerWidth() + i.innerWidth() < 0) {
                        t = "left"
                    }
                }
                console.log("offsetTop: " + w.clientY + ", innerHeight: " + k.innerHeight() + ", windowHeight" + m);
                if (w.clientY + k.innerHeight() > m) {
                    if (q - k.innerHeight() < 0) {
                        var o = m - q;
                        k.css("max-height", o)
                    } else {
                        z -= w.clientY + k.innerHeight() - m
                    }
                }
                if (t === "left") {
                    y = d.gutter;
                    u = n.x + y
                } else {
                    if (t === "right") {
                        var s = n.x + i.outerWidth() - k.outerWidth();
                        y = -d.gutter;
                        u = s + y
                    }
                }
                k.css({
                    position: "absolute",
                    top: n.y + z + v,
                    left: u + x
                });
                k.stop(true, true).css("opacity", 0).slideDown({
                    queue: false,
                    duration: d.inDuration,
                    easing: "easeOutCubic",
                    complete: function () {
                        a(this).css("height", "")
                    }
                }).animate({
                    opacity: 1
                }, {
                    queue: false,
                    duration: d.inDuration,
                    easing: "easeOutSine"
                })
            }
            function h() {
                f = false;
                k.fadeOut(d.outDuration);
                k.removeClass("active");
                i.removeClass("active");
                setTimeout(function () {
                    k.css("max-height", "")
                }, d.outDuration)
            }
            function g(q) {
                var m = 0
                    , p = 0
                    , t = "";
                if (typeof window.getSelection != "undefined") {
                    var o = window.getSelection().getRangeAt(0);
                    var n = o.cloneRange();
                    n.selectNodeContents(q);
                    n.setEnd(o.startContainer, o.startOffset);
                    m = n.toString().length;
                    p = m + o.toString().length;
                    t = o.toString()
                } else {
                    if (typeof document.selection != "undefined" && document.selection.type != "Control") {
                        var r = document.selection.createRange();
                        var s = document.body.createTextRange();
                        s.moveToElementText(q);
                        s.setEndPoint("EndToStart", r);
                        m = s.text.length;
                        p = m + r.text.length;
                        t = r.text
                    }
                }
                return {
                    start: m,
                    end: p,
                    selectedText: t
                }
            }
            i.unbind("contextmenu." + i.attr("id"));
            i.bind("contextmenu." + i.attr("id"), function (n) {
                if (!f) {
                    if (i[0] == n.currentTarget && (a(n.target).closest(".dropdown-content").length === 0)) {
                        var m = g(this);
                        if (m.start < m.end) {
                            selectedRange = m;
                            n.preventDefault();
                            if (d.stopPropagation) {
                                n.stopPropagation()
                            }
                            j(n, "click")
                        } else {
                            if (i.hasClass("active")) {
                                h();
                                a(document).unbind("click." + k.attr("id") + " touchstart." + k.attr("id"))
                            }
                        }
                    }
                }
            });
            i.unbind("click." + i.attr("id"));
            i.bind("click." + i.attr("id"), function (m) {
                if (!f) {
                    if (i.hasClass("active")) {
                        h();
                        a(document).unbind("click." + k.attr("id") + " touchstart." + k.attr("id"))
                    }
                    if (k.hasClass("active")) {
                        a(document).bind("click." + k.attr("id") + " touchstart." + k.attr("id"), function (n) {
                            if (!k.is(n.target) && !i.is(n.target) && (!i.find(n.target).length)) {
                                h();
                                a(document).unbind("click." + k.attr("id") + " touchstart." + k.attr("id"))
                            }
                        })
                    }
                }
            });
            i.on("open", function (n, m) {
                j(n, m)
            });
            i.on("close", h)
        })
    }
        ;
    a(document).ready(function () {
        a(".contextmenu-button").contextmenu()
    })
}(jQuery));
